<?php
/**
 * ุงุฎุชุจุงุฑ ุณููุงุฑูู ุฅุฑุฌุงุน ุงูุฃููุงู ุงููุงูู
 *
 * ุงูุณููุงุฑูู:
 * 1. ุฅูุดุงุก ุตููุฉ ุฌุฏูุฏุฉ (ุงููุดุชุฑู ูุฏูุน โ pending_balance ูููุดุชุฑู)
 * 2. ุฑูุถ ุงูุตููุฉ ูู ุงูุฃุฏูู (ุงููููุณ ุชุฑูุญ ูู pending_balance ุงููุดุชุฑู โ pending_balance ุงูุฃุฏูู)
 * 3. ุงูุฃุฏูู ูุฑุฌุน ุงููููุณ ูููุณุชุฎุฏู (ูู pending_balance ุงูุฃุฏูู โ balance ุงููุณุชุฎุฏู)
 */

// ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ
$host = 'localhost';
$dbname = 'bvize_games_accounts';
$username = 'root';
$password = '';

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8mb4", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    $pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    die("Database connection error: " . $e->getMessage() . "\n");
}

echo "=== ุงุฎุชุจุงุฑ ุณููุงุฑูู ุฅุฑุฌุงุน ุงูุฃููุงู ุงููุงูู ===\n\n";

try {
    // 1. ุงูุญุตูู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏููู
    echo "1๏ธโฃ ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏููู...\n";

    // ุงูุญุตูู ุนูู ุงูุฃุฏูู/ุงููุธุงู
    $stmt = $pdo->prepare("SELECT id, name, email, role FROM users WHERE role = 'admin' OR role = 'system' ORDER BY role DESC LIMIT 1");
    $stmt->execute();
    $admin = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$admin) {
        echo "โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุญุณุงุจ ุฅุฏุงุฑุฉ/ูุธุงู!\n";
        echo "   ุณุฃููู ุจุฅูุดุงุก ุญุณุงุจ ูุธุงู...\n";
        $stmt = $pdo->prepare("INSERT INTO users (name, email, password, role) VALUES ('System', 'system@system.com', 'xxxxx', 'system')");
        $stmt->execute();
        $admin_id = $pdo->lastInsertId();
        $admin = ['id' => $admin_id, 'name' => 'System', 'email' => 'system@system.com', 'role' => 'system'];
    }

    echo "   โ ุญุณุงุจ ุงูุฅุฏุงุฑุฉ: {$admin['name']} (ID: {$admin['id']})\n\n";

    // ุงูุญุตูู ุนูู ูุณุชุฎุฏููู ุนุงุฏููู (ูุดุชุฑู ูุจุงุฆุน)
    $stmt = $pdo->prepare("SELECT id, name, email FROM users WHERE (role IS NULL OR role NOT IN ('admin', 'system')) AND id != ? LIMIT 2");
    $stmt->execute([$admin['id']]);
    $users = $stmt->fetchAll(PDO::FETCH_ASSOC);

    if (count($users) < 2) {
        echo "โ ูุง ููุฌุฏ ูุณุชุฎุฏููู ูุงูููู ููุงุฎุชุจุงุฑ!\n";
        exit;
    }

    $buyer = $users[0];
    $seller = $users[1];

    echo "   โ ุงููุดุชุฑู: {$buyer['name']} (ID: {$buyer['id']})\n";
    echo "   โ ุงูุจุงุฆุน: {$seller['name']} (ID: {$seller['id']})\n\n";

    // 2. ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุญุงูุธ ููุฌููุน
    echo "2๏ธโฃ ุงูุชุญูู ูู ุงููุญุงูุธ ูุฅูุดุงุฆูุง ุฅุฐุง ูุฒู ุงูุฃูุฑ...\n";

    foreach ([$admin['id'], $buyer['id'], $seller['id']] as $user_id) {
        $stmt = $pdo->prepare("SELECT * FROM wallets WHERE user_id = ?");
        $stmt->execute([$user_id]);
        $wallet = $stmt->fetch(PDO::FETCH_ASSOC);

        if (!$wallet) {
            $stmt = $pdo->prepare("INSERT INTO wallets (user_id, balance, pending_balance) VALUES (?, 0.00, 0.00)");
            $stmt->execute([$user_id]);
            echo "   โ ุชู ุฅูุดุงุก ูุญูุธุฉ ูููุณุชุฎุฏู ID: {$user_id}\n";
        }
    }
    echo "\n";

    // 3. ุนุฑุถ ุงูุฃุฑุตุฏุฉ ูุจู ุงูุจุฏุงูุฉ
    echo "3๏ธโฃ ุงูุฃุฑุตุฏุฉ ูุจู ุงูุจุฏุงูุฉ:\n";
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";

    $stmt = $pdo->prepare("
        SELECT u.id, u.name, COALESCE(w.balance, 0) as balance, COALESCE(w.pending_balance, 0) as pending_balance
        FROM users u
        LEFT JOIN wallets w ON u.id = w.user_id
        WHERE u.id IN (?, ?, ?)
    ");
    $stmt->execute([$admin['id'], $buyer['id'], $seller['id']]);
    $wallets_before = $stmt->fetchAll(PDO::FETCH_ASSOC);

    foreach ($wallets_before as $w) {
        echo sprintf("   %-20s | ุฑุตูุฏ: %8.2f | ูุนูู: %8.2f\n", $w['name'], $w['balance'], $w['pending_balance']);
    }
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n";

    // 4. ุฅุถุงูุฉ ุฑุตูุฏ ูููุดุชุฑู ููุงุฎุชุจุงุฑ
    $test_amount = 1000.00;
    echo "4๏ธโฃ ุฅุถุงูุฉ {$test_amount} ุฌููู ูููุดุชุฑู ููุงุฎุชุจุงุฑ...\n";
    $stmt = $pdo->prepare("UPDATE wallets SET balance = balance + ? WHERE user_id = ?");
    $stmt->execute([$test_amount, $buyer['id']]);
    echo "   โ ุชูุช ุงูุฅุถุงูุฉ\n\n";

    // 5. ุฅูุดุงุก ุตููุฉ ุฌุฏูุฏุฉ
    $deal_amount = 500.00;
    echo "5๏ธโฃ ุฅูุดุงุก ุตููุฉ ุฌุฏูุฏุฉ ุจูุจูุบ {$deal_amount} ุฌููู...\n";

    $pdo->beginTransaction();

    // ุฎุตู ูู ุฑุตูุฏ ุงููุดุชุฑู ูุฅุถุงูุฉ ููุฑุตูุฏ ุงููุนูู
    $stmt = $pdo->prepare("UPDATE wallets SET balance = balance - ?, pending_balance = pending_balance + ? WHERE user_id = ?");
    $stmt->execute([$deal_amount, $deal_amount, $buyer['id']]);

    // ุฅูุดุงุก ุงูุตููุฉ
    $stmt = $pdo->prepare("
        INSERT INTO deals (buyer_id, seller_id, amount, status, escrow_status, created_at, updated_at)
        VALUES (?, ?, ?, 'FUNDED', 'HELD', NOW(), NOW())
    ");
    $stmt->execute([$buyer['id'], $seller['id'], $deal_amount]);
    $deal_id = $pdo->lastInsertId();

    $pdo->commit();

    echo "   โ ุชู ุฅูุดุงุก ุงูุตููุฉ ID: {$deal_id}\n";
    echo "   โ ุชู ุฎุตู {$deal_amount} ูู ุฑุตูุฏ ุงููุดุชุฑู ูุฅุถุงูุชูุง ููุฑุตูุฏ ุงููุนูู\n\n";

    // 6. ุนุฑุถ ุงูุฃุฑุตุฏุฉ ุจุนุฏ ุฅูุดุงุก ุงูุตููุฉ
    echo "6๏ธโฃ ุงูุฃุฑุตุฏุฉ ุจุนุฏ ุฅูุดุงุก ุงูุตููุฉ:\n";
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";

    $stmt->execute([$admin['id'], $buyer['id'], $seller['id']]);
    $wallets_after_deal = $stmt->fetchAll(PDO::FETCH_ASSOC);

    foreach ($wallets_after_deal as $w) {
        echo sprintf("   %-20s | ุฑุตูุฏ: %8.2f | ูุนูู: %8.2f\n", $w['name'], $w['balance'], $w['pending_balance']);
    }
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n";

    // 7. ุฑูุถ ุงูุตููุฉ ูู ุงูุฃุฏูู (ุงูุฌุฒุก ุงูููู!)
    echo "7๏ธโฃ ุฑูุถ ุงูุตููุฉ ูู ุงูุฃุฏูู...\n";
    echo "   ๐ ูุฌุจ ุฃู ุชูุชูู ุงูุฃููุงู ูู pending_balance ุงููุดุชุฑู โ pending_balance ุงูุฃุฏูู\n";

    $pdo->beginTransaction();

    // ุงูุญุตูู ุนูู ุชูุงุตูู ุงูุตููุฉ
    $stmt = $pdo->prepare('SELECT * FROM deals WHERE id = ?');
    $stmt->execute([$deal_id]);
    $deal = $stmt->fetch(PDO::FETCH_ASSOC);

    $amount_to_refund = $deal['amount'];

    // ุฎุตู ูู ุงูุฑุตูุฏ ุงููุนูู ูููุดุชุฑู
    $stmt = $pdo->prepare('UPDATE wallets SET pending_balance = pending_balance - ? WHERE user_id = ?');
    $stmt->execute([$amount_to_refund, $buyer['id']]);

    // ุฅุถุงูุฉ ููุฑุตูุฏ ุงููุนูู ููุฅุฏุงุฑุฉ
    $stmt = $pdo->prepare('UPDATE wallets SET pending_balance = pending_balance + ? WHERE user_id = ?');
    $stmt->execute([$amount_to_refund, $admin['id']]);

    // ุชุญุฏูุซ ุญุงูุฉ ุงูุตููุฉ
    $stmt = $pdo->prepare('UPDATE deals SET status = "CANCELLED", escrow_status = "REFUNDED", updated_at = NOW() WHERE id = ?');
    $stmt->execute([$deal_id]);

    // ุชุณุฌูู ูู financial_logs
    $stmt = $pdo->prepare('INSERT INTO financial_logs (deal_id, type, amount, from_user, to_user, description) VALUES (?, "REFUND_TO_ADMIN", ?, ?, ?, "ุฑูุถ ุงูุตููุฉ - ุฅุฑุฌุงุน ููุฅุฏุงุฑุฉ")');
    $stmt->execute([$deal_id, $amount_to_refund, $buyer['id'], $admin['id']]);

    $pdo->commit();

    echo "   โ ุชู ุฑูุถ ุงูุตููุฉ ูุฅุฑุฌุงุน ุงูุฃููุงู ููุฅุฏุงุฑุฉ\n\n";

    // 8. ุนุฑุถ ุงูุฃุฑุตุฏุฉ ุจุนุฏ ุฑูุถ ุงูุตููุฉ
    echo "8๏ธโฃ ุงูุฃุฑุตุฏุฉ ุจุนุฏ ุฑูุถ ุงูุตููุฉ:\n";
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";

    $stmt = $pdo->prepare("
        SELECT u.id, u.name, COALESCE(w.balance, 0) as balance, COALESCE(w.pending_balance, 0) as pending_balance
        FROM users u
        LEFT JOIN wallets w ON u.id = w.user_id
        WHERE u.id IN (?, ?, ?)
    ");
    $stmt->execute([$admin['id'], $buyer['id'], $seller['id']]);
    $wallets_after_reject = $stmt->fetchAll(PDO::FETCH_ASSOC);

    foreach ($wallets_after_reject as $w) {
        echo sprintf("   %-20s | ุฑุตูุฏ: %8.2f | ูุนูู: %8.2f\n", $w['name'], $w['balance'], $w['pending_balance']);
    }
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";

    // ุงูุชุญูู ูู ุฃู ุงูุฃููุงู ูู pending_balance ุงูุฃุฏูู
    $admin_wallet = array_filter($wallets_after_reject, function($w) use ($admin) {
        return $w['id'] == $admin['id'];
    });
    $admin_wallet = array_values($admin_wallet)[0];

    if ($admin_wallet['pending_balance'] >= $amount_to_refund) {
        echo "   โ ุงูุฃููุงู ููุฌูุฏุฉ ูู ุงูุฑุตูุฏ ุงููุนูู ููุฅุฏุงุฑุฉ: {$admin_wallet['pending_balance']} ุฌููู\n\n";
    } else {
        echo "   โ ุฎุทุฃ! ุงูุฃููุงู ุบูุฑ ููุฌูุฏุฉ ูู ุงูุฑุตูุฏ ุงููุนูู ููุฅุฏุงุฑุฉ!\n\n";
    }

    // 9. ุงูุฃุฏูู ูุฑุฌุน ุงูุฃููุงู ูููุณุชุฎุฏู
    echo "9๏ธโฃ ุงูุฃุฏูู ูุฑุฌุน ุงูุฃููุงู ูููุณุชุฎุฏู...\n";
    echo "   ๐ ูุฌุจ ุฃู ุชูุชูู ุงูุฃููุงู ูู pending_balance ุงูุฃุฏูู โ balance ุงููุณุชุฎุฏู\n";

    $pdo->beginTransaction();

    // ุฎุตู ูู ุงูุฑุตูุฏ ุงููุนูู ููุฅุฏุงุฑุฉ
    $stmt = $pdo->prepare("UPDATE wallets SET pending_balance = pending_balance - ? WHERE user_id = ?");
    $stmt->execute([$amount_to_refund, $admin['id']]);

    // ุฅุถุงูุฉ ููุฑุตูุฏ ุงูุฃุณุงุณู ูููุณุชุฎุฏู
    $stmt = $pdo->prepare("UPDATE wallets SET balance = balance + ? WHERE user_id = ?");
    $stmt->execute([$amount_to_refund, $buyer['id']]);

    // ุชุณุฌูู ูู financial_logs
    $stmt = $pdo->prepare("INSERT INTO financial_logs (deal_id, type, amount, from_user, to_user, description) VALUES (?, 'ADMIN_REFUND', ?, ?, ?, 'ุงุณุชุฑุฏุงุฏ ูู ุงูุฅุฏุงุฑุฉ ูููุณุชุฎุฏู')");
    $stmt->execute([$deal_id, $amount_to_refund, $admin['id'], $buyer['id']]);

    $pdo->commit();

    echo "   โ ุชู ุฅุฑุฌุงุน ุงูุฃููุงู ูููุณุชุฎุฏู ุจูุฌุงุญ\n\n";

    // 10. ุนุฑุถ ุงูุฃุฑุตุฏุฉ ุงูููุงุฆูุฉ
    echo "๐ ุงูุฃุฑุตุฏุฉ ุงูููุงุฆูุฉ:\n";
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";

    $stmt = $pdo->prepare("
        SELECT u.id, u.name, COALESCE(w.balance, 0) as balance, COALESCE(w.pending_balance, 0) as pending_balance
        FROM users u
        LEFT JOIN wallets w ON u.id = w.user_id
        WHERE u.id IN (?, ?, ?)
    ");
    $stmt->execute([$admin['id'], $buyer['id'], $seller['id']]);
    $wallets_final = $stmt->fetchAll(PDO::FETCH_ASSOC);

    foreach ($wallets_final as $w) {
        echo sprintf("   %-20s | ุฑุตูุฏ: %8.2f | ูุนูู: %8.2f\n", $w['name'], $w['balance'], $w['pending_balance']);
    }
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n";

    // 11. ุนุฑุถ ุณุฌู ุงููุนุงููุงุช ุงููุงููุฉ
    echo "1๏ธโฃ1๏ธโฃ ุณุฌู ุงููุนุงููุงุช ุงููุงููุฉ ููุตููุฉ:\n";
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";

    $stmt = $pdo->prepare("
        SELECT
            fl.type,
            fl.amount,
            u1.name as from_user_name,
            u2.name as to_user_name,
            fl.description,
            fl.created_at
        FROM financial_logs fl
        LEFT JOIN users u1 ON fl.from_user = u1.id
        LEFT JOIN users u2 ON fl.to_user = u2.id
        WHERE fl.deal_id = ?
        ORDER BY fl.created_at ASC
    ");
    $stmt->execute([$deal_id]);
    $logs = $stmt->fetchAll(PDO::FETCH_ASSOC);

    foreach ($logs as $log) {
        echo sprintf("   %s: %s โ %s | %8.2f ุฌููู | %s\n",
            $log['type'],
            $log['from_user_name'] ?: 'ุงููุธุงู',
            $log['to_user_name'] ?: 'ุงููุธุงู',
            $log['amount'],
            $log['description'] ?: ''
        );
    }
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n";

    // 12. ุงูุชุญูู ูู ุงููุชุงุฆุฌ
    echo "1๏ธโฃ2๏ธโฃ ุงูุชุญูู ูู ุงููุชุงุฆุฌ:\n";

    $buyer_final = array_filter($wallets_final, function($w) use ($buyer) {
        return $w['id'] == $buyer['id'];
    });
    $buyer_final = array_values($buyer_final)[0];

    $admin_final = array_filter($wallets_final, function($w) use ($admin) {
        return $w['id'] == $admin['id'];
    });
    $admin_final = array_values($admin_final)[0];

    $buyer_expected_balance = $test_amount; // ููุณ ุงููุจูุบ ุงูุฃุตูู (1000) ูุฃู ุงููููุณ ุฑุฌุนุช
    $buyer_expected_pending = 0; // ูุฌุจ ุฃู ูููู ุตูุฑ

    echo "   ุงููุดุชุฑู - ุงูุฑุตูุฏ ุงููุชููุน: {$buyer_expected_balance} | ุงููุนูู: {$buyer_final['balance']}\n";
    echo "   ุงููุดุชุฑู - ุงูุฑุตูุฏ ุงููุนูู ุงููุชููุน: {$buyer_expected_pending} | ุงููุนูู: {$buyer_final['pending_balance']}\n";
    echo "   ุงูุฅุฏุงุฑุฉ - ุงูุฑุตูุฏ ุงููุนูู ุงููุชููุน: 0 | ุงููุนูู: {$admin_final['pending_balance']}\n\n";

    if (abs($buyer_final['balance'] - $buyer_expected_balance) < 0.01 &&
        abs($buyer_final['pending_balance'] - $buyer_expected_pending) < 0.01 &&
        abs($admin_final['pending_balance']) < 0.01) {
        echo "   โโโ ุงููุชุงุฆุฌ ุตุญูุญุฉ! ุงูุณููุงุฑูู ุนูู ุจูุฌุงุญ! โโโ\n";
    } else {
        echo "   โ ููุงู ุฎุทุฃ ูู ุงูุฃุฑุตุฏุฉ!\n";
    }

    echo "\n=== ุงูุชูู ุงูุงุฎุชุจุงุฑ ===\n";

} catch (Exception $e) {
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }
    echo "โ ุฎุทุฃ: " . $e->getMessage() . "\n";
    echo "Stack trace:\n" . $e->getTraceAsString() . "\n";
}
?>
