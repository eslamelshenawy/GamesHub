<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>نسيت كلمة المرور — GamesHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #0b0f14;
            color: #fff;
            -webkit-font-smoothing: antialiased;
            background-image: radial-gradient(circle, rgba(155, 89, 255, 0.1) 1px, transparent 1px), radial-gradient(circle, rgba(0, 212, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
            animation: pulse-bg 10s infinite alternate;
        }
        @keyframes pulse-bg {
            from { background-color: #0b0f14; }
            to { background-color: #0d1218; }
        }
        .neon-btn {
            background: linear-gradient(90deg, #9b59ff, #00d4ff); 
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md p-8 space-y-6 bg-slate-900 rounded-xl shadow-lg">
        <div class="text-center">
            <h2 class="text-3xl font-bold bg-clip-text text-transparent" style="background-image: linear-gradient(90deg, #9b59ff, #00d4ff);">GamesHub</h2>
            <h1 class="text-2xl font-bold mt-4">نسيت كلمة المرور؟</h1>
            <p class="text-sm text-gray-400 mt-2">لا تقلق، سنساعدك في استعادة حسابك</p>
        </div>

        <!-- الخطوة الأولى: إدخال البريد الإلكتروني -->
        <div id="step1" class="step active">
            <form id="emailForm" class="space-y-4">
                <div class="relative">
                    <input type="email" id="email" placeholder="البريد الإلكتروني" required 
                           class="w-full p-4 pr-12 rounded-xl bg-gray-800 border border-gray-700 outline-none focus:ring-2 focus:ring-[#00d4ff] transition">
                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                        </svg>
                    </div>
                </div>
                <button type="submit" id="sendCodeBtn" class="w-full neon-btn text-black font-semibold p-4 rounded-xl text-lg hover:opacity-80 transition">
                    إرسال رمز التحقق
                </button>
            </form>
        </div>

        <!-- الخطوة الثانية: التحقق من الرمز -->
        <div id="step2" class="step">
            <div class="text-center mb-4">
                <p class="text-sm text-gray-400">تم إرسال رمز التحقق إلى بريدك الإلكتروني</p>
                <p class="text-xs text-gray-500 mt-1">الرمز صالح لمدة 30 دقيقة</p>
            </div>
            <form id="verifyForm" class="space-y-4">
                <div class="relative">
                    <input type="text" id="verificationCode" placeholder="رمز التحقق" required maxlength="6"
                           class="w-full p-4 text-center rounded-xl bg-gray-800 border border-gray-700 outline-none focus:ring-2 focus:ring-[#00d4ff] transition text-2xl tracking-widest">
                </div>
                <button type="submit" id="verifyCodeBtn" class="w-full neon-btn text-black font-semibold p-4 rounded-xl text-lg hover:opacity-80 transition">
                    التحقق من الرمز
                </button>
                <button type="button" id="resendBtn" class="w-full text-[#00d4ff] hover:underline text-sm">
                    إعادة إرسال الرمز
                </button>
            </form>
        </div>

        <!-- الخطوة الثالثة: تغيير كلمة المرور -->
        <div id="step3" class="step">
            <div class="text-center mb-4">
                <p class="text-sm text-gray-400">أدخل كلمة المرور الجديدة</p>
            </div>
            <form id="resetForm" class="space-y-4">
                <div class="relative">
                    <input type="password" id="newPassword" placeholder="كلمة المرور الجديدة" required minlength="6"
                           class="w-full p-4 pr-12 rounded-xl bg-gray-800 border border-gray-700 outline-none focus:ring-2 focus:ring-[#00d4ff] transition">
                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                </div>
                <div class="relative">
                    <input type="password" id="confirmPassword" placeholder="تأكيد كلمة المرور" required minlength="6"
                           class="w-full p-4 pr-12 rounded-xl bg-gray-800 border border-gray-700 outline-none focus:ring-2 focus:ring-[#00d4ff] transition">
                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                </div>
                <button type="submit" id="resetPasswordBtn" class="w-full neon-btn text-black font-semibold p-4 rounded-xl text-lg hover:opacity-80 transition">
                    تغيير كلمة المرور
                </button>
            </form>
        </div>

        <div class="text-center">
            <a href="login.html" class="text-[#00d4ff] hover:underline text-sm">العودة إلى تسجيل الدخول</a>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white bg-slate-800 shadow-lg hidden z-50"></div>

    <script>
        let currentStep = 1;
        let resetToken = null;
        let userEmail = null;
        
        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            // Show current step
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <span class="toast-icon">${type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ'}</span>
                    <span class="toast-message">${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Add styles for toast
            if (!document.getElementById('toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    .toast {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 15px 20px;
                        border-radius: 8px;
                        color: white;
                        font-weight: 500;
                        z-index: 10000;
                        animation: slideIn 0.3s ease;
                        max-width: 400px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    }
                    .toast-success { background: linear-gradient(135deg, #28a745, #20c997); }
                    .toast-error { background: linear-gradient(135deg, #dc3545, #e74c3c); }
                    .toast-info { background: linear-gradient(135deg, #17a2b8, #007bff); }
                    .toast-content { display: flex; align-items: center; gap: 10px; }
                    .toast-icon { font-size: 18px; }
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function setLoading(elementId, isLoading) {
            const element = document.getElementById(elementId);
            if (isLoading) {
                element.disabled = true;
                element.innerHTML = '<span class="spinner"></span> جاري المعالجة...';
            } else {
                element.disabled = false;
                element.innerHTML = element.getAttribute('data-original-text');
            }
        }
        
        // Step 1: Send verification code
        async function sendCode() {
            const emailInput = document.getElementById('email');
            const email = emailInput.value.trim();
            const sendBtn = document.getElementById('sendCodeBtn');
            
            if (!email) {
                showToast('يرجى إدخال البريد الإلكتروني', 'error');
                emailInput.focus();
                return;
            }
            
            if (!isValidEmail(email)) {
                showToast('يرجى إدخال بريد إلكتروني صحيح', 'error');
                emailInput.focus();
                return;
            }
            
            setLoading('sendCodeBtn', true);
            
            try {
                const response = await fetch('api/send_reset_code.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resetToken = data.token;
                    userEmail = email;
                    showToast('تم إرسال رمز التحقق بنجاح', 'success');
                    showStep(2);
                    document.getElementById('verificationCode').focus();
                } else {
                    showToast(data.error || 'حدث خطأ في إرسال الرمز', 'error');
                }
            } catch (error) {
                showToast('حدث خطأ في الاتصال بالخادم', 'error');
                console.error('Error:', error);
            } finally {
                setLoading('sendCodeBtn', false);
            }
        }
        
        // Step 2: Verify code
        async function verifyCode() {
             const codeInput = document.getElementById('verificationCode');
             const code = codeInput.value.trim();
             const verifyBtn = document.getElementById('verifyCodeBtn');
            
            if (!code) {
                showToast('يرجى إدخال رمز التحقق', 'error');
                codeInput.focus();
                return;
            }
            
            if (!/^\d{6}$/.test(code)) {
                showToast('رمز التحقق يجب أن يكون 6 أرقام', 'error');
                codeInput.focus();
                return;
            }
            
            if (!resetToken) {
                showToast('جلسة غير صحيحة، يرجى البدء من جديد', 'error');
                showStep(1);
                return;
            }
            
            setLoading('verifyCodeBtn', true);
            
            try {
                const response = await fetch('api/verify_reset_code.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        code: code,
                        token: resetToken
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('تم التحقق من الرمز بنجاح', 'success');
                    showStep(3);
                    document.getElementById('newPassword').focus();
                } else {
                    showToast(data.error || 'رمز التحقق غير صحيح', 'error');
                }
            } catch (error) {
                showToast('حدث خطأ في الاتصال بالخادم', 'error');
                console.error('Error:', error);
            } finally {
                setLoading('verifyCodeBtn', false);
            }
        }
        
        // Step 3: Reset password
        async function resetPassword() {
             const newPasswordInput = document.getElementById('newPassword');
             const confirmPasswordInput = document.getElementById('confirmPassword');
             const newPassword = newPasswordInput.value;
             const confirmPassword = confirmPasswordInput.value;
             const resetBtn = document.getElementById('resetPasswordBtn');
            
            if (!newPassword || !confirmPassword) {
                showToast('يرجى ملء جميع الحقول', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                newPasswordInput.focus();
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('كلمات المرور غير متطابقة', 'error');
                confirmPasswordInput.focus();
                return;
            }
            
            if (!resetToken) {
                showToast('جلسة غير صحيحة، يرجى البدء من جديد', 'error');
                showStep(1);
                return;
            }
            
            setLoading('resetPasswordBtn', true);
            
            try {
                const response = await fetch('api/reset_password.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        password: newPassword,
                        confirm_password: confirmPassword,
                        token: resetToken
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('تم تغيير كلمة المرور بنجاح', 'success');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    showToast(data.error || 'حدث خطأ في تغيير كلمة المرور', 'error');
                }
            } catch (error) {
                showToast('حدث خطأ في الاتصال بالخادم', 'error');
                console.error('Error:', error);
            } finally {
                 setLoading('resetPasswordBtn', false);
             }
         }
        
        // Utility functions
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        function goBack() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }
        
        function startOver() {
            resetToken = null;
            userEmail = null;
            document.getElementById('email').value = '';
            document.getElementById('verificationCode').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            showStep(1);
        }
        
        // Event listeners for forms
        document.getElementById('emailForm').addEventListener('submit', function(e) {
            e.preventDefault();
            sendCode();
        });
        
        document.getElementById('verifyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            verifyCode();
        });
        
        document.getElementById('resetForm').addEventListener('submit', function(e) {
            e.preventDefault();
            resetPassword();
        });
        
        // إعادة إرسال الرمز
        document.getElementById('resendBtn').addEventListener('click', function() {
            showStep(1);
            document.getElementById('email').value = userEmail;
        });
        
        // تنسيق إدخال رمز التحقق
        document.getElementById('verificationCode').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showStep(1);
            
            // Store original button texts
            document.querySelectorAll('button[id$="Btn"]').forEach(btn => {
                btn.setAttribute('data-original-text', btn.innerHTML);
            });
            
            // Add Enter key support
            document.getElementById('email').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendCode();
            });
            
            document.getElementById('verificationCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') verifyCode();
            });
            
            document.getElementById('confirmPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') resetPassword();
            });
        });
    </script>
</body>
</html>